<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Typing Test</title>
<link rel="stylesheet" href="src/settings.css">
<script src="src/settings.js"></script>
<script src="src/data.js"></script>
<style>

  html, body{ height: 100%; width:100%; margin: 0; padding:0;}

  body {
    font-family: Arial, sans-serif;
    align-items: center;
  }

  #testArea {
    padding:50px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  body {
    background-color: rgb(28, 43, 43);
  }

  body, #wordsContainer, #inputField, #timer{
    color:lightgray;
  }

  #wordsContainer, #inputField, #timer, .resContainer{
    border: 1px solid #ccc;
    border-radius: 10px;
    padding: 10px;
    font-size: 30px;
    background-color: rgba(0,0,0,0.25);
  }


  #inputField {
    width: 100%;
  }
  #timer {
    width: 100%;
    margin-top: 10px;
    margin-bottom: 10px;
    opacity: 0.25;
  }

  #wordsContainer {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    white-space: pre-wrap; /* Keeps the line breaks */
    border-radius: 10px;
    height: 150px;
    overflow: auto;
  }

  /* Word styles */
  .word {
    padding: 5px;
    margin: 2px;
    float:left;
    font-size: 30px;
  }
  .current {
    background-color: rgba(0,0,0,0.75);
    border-radius: 10px;
  }
  .done {
    text-decoration: line-through;
    color: #777;
  }
  .current.wrong {
    background-color: rgba(153, 21, 21, 0.432); /* Add a red border for incorrect input */
  }
  .done.wrong {
    color: rgb(54, 33, 33); /* Add a red border for incorrect input */
  }


  /* Resault styles */

  #resault{
    margin-top: 10px;
    width: 100%;
  }

  .resContainer .resRow {
    /*width: 100%;*/
    padding: 10px;
  }  
  
  .resContainer .resRow div{
    width: 50%;
    display: inline-block;
    
  }

  .resContainer .resRow:nth-child(2n) {
    background-color: rgba(0,0,0,0.25);
  }

  .resTitle {
    width: 20%;
    opacity: 0.5;
  }
  .resValue {
    width: 60%;
  }

  /* Scrollbar styles */
  ::-webkit-scrollbar {
    width: 20px;
    height: 10px;
    background: transparent;

  }
  
  ::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 15px;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  
  ::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 15px;
    box-shadow: inset 0 0 5px grey;
    opacity: 0.1;
  }


</style>
</head>
<body>
  <div id="testArea">
    <div id="wordsContainer">
      <!-- The text to be typed goes here -->
      nichts ich sehr wer einen soll wurden dieses hatten einem welches so mir es schon des gemacht Seite würde wie
    </div>
    <input type="text" id="inputField" autocomplete="off" >
    <div id="timer">
      Time: <span id="timeElapsed">0:00</span>
    </div>
    <div id="resault"></div>
</div>
<script>

  let words = "gar|werde|Menschen|des|sei|uns|damit|kann|weil|hier|dies|der|zum|also|über|dessen|doch|mein|von|lassen|vielleicht|meiner|Jahre|zu|welche|können|einen|müssen|ihn|muss|ganzen|seiner|auf|wurde|dem|Welt|in|beiden|Zeit|erst|wieder|werden|gemacht|da|allen|sagen|ganze|ob|nur|vor|lange|und|wollen|einmal|konnte|sehr|für|wohl|dann|wurden|jetzt|aus|gegen|eben|wir|ganz|diesem|soll|ich|als|einzelnen|ihr|seinem|keine|so|anderen|eine|bald|hatten|an|ihrem|allein|du|eines|ihren|was|nichts|wo|habe|vom|euch|ein|sie|wenn|sind|diesen|seine|unter|auch|er|würde|darauf|war|recht|zwei|dir|worden|Liebe|gewesen|etwas|Seite|gut|Weise|mit|es|anders|sein|das|Mann|Herr|nicht|schon|alle|kommen|dieser|welches|ihnen|oder|alles|nach|waren|während|ohne|viel|den|sich|aber|zwar|weit|wie|wer|dort|haben|bin|heute|ihrer|ihm|ja|ihre|am|welcher|Frau|bis|bei|meine|dich|Leben|zwischen|noch|mir|denn|sollte|Hand|denen|solche|sehen|diese|nun|mich|ersten|einem|die|einer|dieses|sondern|im|dass|deren|hatte|selbst|wird|man|seinen|macht|kein|will|immer|um|hat|mehr|hätte|ist|weiter|durch|machen";

  class TypingTest {
  onEnd = undefined;
  constructor(words) {
    this.words = this.uniqueWords(words);
    this.timeElapsed = document.getElementById('timeElapsed');
    this.inputField = document.getElementById('inputField');
    this.wordsContainer = document.getElementById('wordsContainer');
    this.resault = document.getElementById('resault');
    this.wordsToGenerate = 50;
    this.inputEvent = (event) => this.checkInput(event);
    this.reset();
  }

  reset(){
    this.startTime = null;
    this.endTime = null;
    this.currentIndex = this.rightWords = this.wrongWords = this.keyHits = this.rightKeys = this.wrongKeys = 0;
    this.clearInputField();
    this.clearWordElements();
    this.init();
    this.scrollIntoView();
  }

  uniqueWords(str) { return Array.from(new Set(str.split('|').filter(word => word.trim() !== '')));}
  shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  createWordElements() {
    let toGenerate = this.wordsToGenerate;
    let wordsElements = ``;
    while(toGenerate > 0){
      this.shuffleArray(this.words).some((word) =>{ if(--toGenerate>=0) wordsElements += `<div class="word">${word}</div>`; });
    }
    this.wordsContainer.innerHTML = wordsElements;
    this.markWordCurrent();
  }

  clearWordElements() { this.wordsContainer.innerHTML = ''; }
  clearInputField(){ this.inputField.removeEventListener('input', this.inputEvent); this.inputField.value = ""; }

  getWordElement() { return this.wordsContainer.children[this.currentIndex]; }
  markWordCurrent() { this.getWordElement()?.classList.add('current'); }
  removeWordCurrent() { this.getWordElement()?.classList.remove('current'); }
  markWordDone() { this.getWordElement()?.classList.add('done'); }
  scrollIntoView() { this.getWordElement()?.scrollIntoView({ behavior: 'smooth', block: 'center' }); }

  nextWord() {
    this.removeWordCurrent();
    this.markWordDone();
    if(++this.currentIndex == this.wordsContainer.children.length){ this.end(); return; }
    this.markWordCurrent();
    this.scrollIntoView();
  }

  end(){
    this.endTime = new Date();
    clearInterval(this.timer);

    let total = (new Date() - this.startTime) / 1000;
    let totalKey = this.wrongKeys + this.rightKeys;
    let minutes = total / 60;
    let res = [
      ["KPM", totalKey / minutes],
      ["Keys", totalKey],
      ["Wrong Keys", this.wrongKeys],
      ["Right Keys", this.rightKeys],
      ["Key(%)", (this.rightKeys / totalKey * 100)],
      ["WPM", (this.wrongWords + this.rightWords) / minutes],
      ["Wrong Words", this.wrongWords],
      ["Right Words", this.rightWords],
      ["Seconds", total]];

    let resText = "";
    res.forEach(xr => resText += `<div class="resRow"><div class="resTitle">${xr[0]}</div><div class="resValue">${xr[1]}</div></div>`);
    this.resault.innerHTML =`<div class="resContainer">${resText}</div>`;

    if(this.onEnd) this.onEnd(this.startTime, res, this.endTime)
  }

  init() {
    this.inputField.addEventListener('input', this.inputEvent);
    this.createWordElements();
    setTimeout(()=>{ this.inputField.focus(); },100)
  }
  updateTime(){
    let total = (new Date() - this.startTime) / 1000;
    this.writeTime(Math.floor(total / 60), Math.floor(total % 60));
  }
  writeTime(minutes, seconds){ this.timeElapsed.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds; }

  checkInput(event){
      if (!this.startTime) {
        this.startTime = new Date();
        this.timer = setInterval(() => this.updateTime(), 1000);
      }
      let current = this.wordsContainer.querySelector('.current');
      const checkWord = this.inputField.value.trim();
      let endWord = event.data === ' ';

      if(!current){ if(checkWord == "new" && endWord){ this.reset();} return; };
      const currentWord = current.textContent;
      let isWrong = checkWord && !currentWord.startsWith(checkWord);
      if(event.data && event.data !== ' ' && event.data !== ''){ if(isWrong){ this.wrongKeys++; } else { this.rightKeys++; };}

      if (endWord && checkWord !== currentWord) { isWrong = true;}
      if(isWrong){ current.classList.add('wrong'); } else { current.classList.remove('wrong'); }

      if (endWord) {
        event.preventDefault();
        if(isWrong){ this.wrongWords++; } else { this.rightWords++; }
        this.nextWord();
        this.inputField.value = '';
      }
  }
}

const typingTest = new TypingTest(words);
</script>

<!-- Settings -->
<div id="SettingsModal">
  <div id="SettingsDrawer"><div id="SettingsDrawerIcon">▲</div></div>
  <div id="SettingsGrid">
    <div class="SettingsHeader">Page Layout</div>
    <div id="SettingMaxWidth" class="SettingsItem"></div>
    <div class="SettingsHeader">Type Test Settings</div>
    <div id="SettingsTestWords" class="SettingsItem"></div>
  </div>
</div>
<script>
  var Settings = new SettingsManager(document.getElementById("SettingsModal"),document.getElementById("SettingsDrawer"));

  let arrea = document.getElementById("testArea");
  Settings.addSetting("SettingMaxWidth", new SettingSlider("Max Width", new IntSetting("TypeTest_PageMaxWidth", 600, 200, 4000), 
    (v)=>{ arrea.style.maxWidth = v+"px"; }));
  Settings.addSetting("SettingsTestWords", new SettingSlider("How Many Words", new IntSetting("TypeTest_Words", 50, 2, 4000), 
    (v)=>{ typingTest.wordsToGenerate = v; typingTest.reset(); }));
</script>
<!-- Data -->
<script>
  const dbName = "testdb";
  const historyObjektStoreName = "TypeTestHistory"
  var data = new SimpleDataStore(dbName, historyObjektStoreName);
  typingTest.onEnd = (st, res, et) => data.write({at: st.getTime(), res: res});
</script>
</body>
</html>
